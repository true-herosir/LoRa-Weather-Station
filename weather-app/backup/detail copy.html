<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard - Detail</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <header>
        <div class="header-content">
            <h1>Weather Dashboard - Detail</h1>
            <div class="last-updated" id="lastUpdated"></div>
        </div>
    </header>

    <div class="container">
        <div class="controls">
            <h2>Location Details</h2>
            <div id="locationDetails" class="location-detail"></div>
            <button class="refresh-button" onclick="updateData()">Refresh Data</button>
        </div>
        <div id="dataContainer" class="table-container"></div>
    </div>

    <script>
        const API_URL = 'http://84.85.32.192:7086/api/Nodes/node_location';
        const urlParams = new URLSearchParams(window.location.search);
        const selectedLocation = urlParams.get('location');
        let currentData = null;

        async function fetchData() {
            try {
                const response = await fetch(`${API_URL}?location=${selectedLocation}&page=1&page_size=100`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                throw error;
            }
        }

        function formatValue(value, unit) {
            return value === null || value === undefined ? 'N/A' : `${parseFloat(value).toFixed(1)}${unit}`;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            const intervals = [
                { name: 'years', seconds: 31536000 },
                { name: 'months', seconds: 2592000 },
                { name: 'days', seconds: 86400 },
                { name: 'hours', seconds: 3600 },
                { name: 'minutes', seconds: 60 }
            ];

            for (const interval of intervals) {
                const count = Math.floor(seconds / interval.seconds);
                if (count > 1) return `${count} ${interval.name} ago`;
            }

            return `${Math.floor(seconds)} seconds ago`;
        }

        function filterDataByLocation(data, location) {
            return data.data.filter(item => item.location === location);
        }

        function displayLocationDetails(location) {
            const container = document.getElementById('locationDetails');
            container.innerHTML = `
                <h3>${location}</h3>
                <p>Details for the selected location.</p>
            `;
        }

        function displayData(data) {
            const container = document.getElementById('dataContainer');
            const filteredData = filterDataByLocation(data, selectedLocation);

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Node ID</th>
                            <th>Location</th>
                            <th>Indoor Temperature (째C)</th>
                            <th>Outdoor Temperature (째C)</th>
                            <th>Humidity (%)</th>
                            <th>Pressure (hPa)</th>
                            <th>Illumination (lux)</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map(item => createTableRow(item)).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;
        }

        function createTableRow(item) {
            return `
                <tr>
                    <td>${item.node_id}</td>
                    <td>${item.location}</td>
                    <td>${formatValue(item.temperature_indoor, '째C')}</td>
                    <td>${formatValue(item.temperature_outdoor, '째C')}</td>
                    <td>${formatValue(item.humidity, '%')}</td>
                    <td>${formatValue(item.pressure, ' hPa')}</td>
                    <td>${formatValue(item.illumination, ' lux')}</td>
                    <td>${getTimeAgo(item.time)}</td>
                </tr>
            `;
        }

        async function updateData() {
            try {
                const data = await fetchData();
                currentData = data;
                displayLocationDetails(selectedLocation);
                displayData(data);
            } catch (error) {
                document.getElementById('dataContainer').innerHTML = `<div class="error-message"><strong>Error:</strong> Failed to fetch sensor data. Please try again later.</div>`;
            }
        }

        // Initial load
        updateData();
    </script>
</body>

</html>
